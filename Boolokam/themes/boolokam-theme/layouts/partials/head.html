<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ if .Title }}{{ .Title }} | {{ end }}{{ .Site.Title }}</title>
<meta name="description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">

<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="{{ "favicon/apple-touch-icon.png" | relURL }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ "favicon/favicon-32x32.png" | relURL }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ "favicon/favicon-16x16.png" | relURL }}">
<link rel="manifest" href="{{ "favicon/site.webmanifest" | relURL }}">

<!-- Preconnect for faster loading -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- CSS -->
<link rel="stylesheet" href="{{ "css/main.css" | relURL }}">

<!-- Open Graph / Social Media Meta Tags -->
<meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}">
<meta property="og:title" content="{{ if .Title }}{{ .Title }}{{ else }}{{ .Site.Title }}{{ end }}">
<meta property="og:description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
<meta property="og:url" content="{{ .Permalink }}">
{{ if .Params.image }}
<meta property="og:image" content="{{ .Params.image | absURL }}">
{{ else if .Params.thumbnail }}
<meta property="og:image" content="{{ .Params.thumbnail | absURL }}">
{{ else if .Params.poster }}
<meta property="og:image" content="{{ .Params.poster | absURL }}">
{{ else if .Site.Params.og_image }}
<meta property="og:image" content="{{ .Site.Params.og_image | absURL }}">
{{ else }}
<meta property="og:image" content="https://images.unsplash.com/photo-1579353977828-2a4eab540b9a">
{{ end }}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ if .Title }}{{ .Title }}{{ else }}{{ .Site.Title }}{{ end }}">
<meta name="twitter:description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
{{ if .Params.image }}
<meta name="twitter:image" content="{{ .Params.image | absURL }}">
{{ else if .Params.thumbnail }}
<meta name="twitter:image" content="{{ .Params.thumbnail | absURL }}">
{{ else if .Params.poster }}
<meta name="twitter:image" content="{{ .Params.poster | absURL }}">
{{ else if .Site.Params.og_image }}
<meta name="twitter:image" content="{{ .Site.Params.og_image | absURL }}">
{{ else }}
<meta name="twitter:image" content="https://images.unsplash.com/photo-1579353977828-2a4eab540b9a">
{{ end }}

<!-- Enhanced Image Fallback Script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Single placeholder image for all content types
    const placeholderImage = '{{ "images/placeholder.jpg" | relURL }}';
    
    // Handle image elements
    function handleImageElements() {
      const allImages = document.querySelectorAll('img:not([data-handled])');
      
      allImages.forEach(function(img) {
        // Mark as handled to avoid processing twice
        img.setAttribute('data-handled', 'true');
        
        // Add loading="lazy" for better performance
        if (!img.hasAttribute('loading')) {
          img.setAttribute('loading', 'lazy');
        }
        
        // Store the original source for reference
        if (!img.getAttribute('data-original-src') && img.src) {
          img.setAttribute('data-original-src', img.src);
        }
        
        // Error handling for images
        img.onerror = function() {
          if (this.classList.contains('img-fallback')) {
            return; // Prevent infinite loop
          }
          
          // Apply the standard placeholder image
          this.src = placeholderImage;
          this.classList.add('img-fallback');
          
          // Add a CSS class to parent for styling
          if (this.parentElement) {
            this.parentElement.classList.add('broken-image');
          }
          
          // Set appropriate dimensions based on container
          setAppropriateImageDimensions(this);
          
          // Prevent infinite error loop
          this.onerror = null;
        };
      });
    }
    
    // Set appropriate dimensions based on container
    function setAppropriateImageDimensions(img) {
      const container = img.parentElement;
      if (!container) return;
      
      // Add appropriate classes based on container
      if (img.closest('.card')) {
        img.style.aspectRatio = '16/9';
        img.style.height = '200px';
      } else if (img.closest('.latest-thumb')) {
        img.style.aspectRatio = '1/1';
      } else if (img.closest('.featured-image')) {
        if (container.offsetHeight) {
          img.style.height = container.offsetHeight + 'px';
        }
      }
      
      img.style.width = '100%';
      img.style.objectFit = 'cover';
    }
    
    // Check if images are already loaded, handle the ones that failed
    function checkExistingImages() {
      document.querySelectorAll('img').forEach(function(img) {
        // Check if image is broken/empty
        if (!img.complete || !img.naturalWidth || img.naturalWidth === 0 || 
            img.src === '' || img.src === 'data:,' || 
            img.src === window.location.href) {
          
          if (!img.classList.contains('img-fallback')) {
            img.src = placeholderImage;
            img.classList.add('img-fallback');
            
            if (img.parentElement) {
              img.parentElement.classList.add('broken-image');
            }
            
            setAppropriateImageDimensions(img);
          }
        }
      });
    }
    
    // Initial handling
    handleImageElements();
    
    // Check for existing broken images
    setTimeout(checkExistingImages, 500);
    
    // For dynamically added content (tabs, ajax, etc.)
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length) {
          handleImageElements();
        }
      });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
  });
</script> 